<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>SOS Connect Pro - IoT Monitoring & Emergency Response Platform</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="IoT Monitoring and Emergency Response Platform with real-time sensor data, weather analysis, and emergency features">
    <meta name="theme-color" content="#e94560">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SOS Connect">
    <meta name="application-name" content="SOS Connect Pro">
    <meta name="msapplication-TileColor" content="#2d1b3d">
    <meta name="msapplication-config" content="none">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%23e94560' width='32' height='32' rx='4'/><text x='16' y='22' font-size='14' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle'>SOS</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23e94560' width='180' height='180' rx='22'/><text x='90' y='115' font-size='70' font-family='Arial' font-weight='bold' fill='white' text-anchor='middle'>SOS</text></svg>">
    
    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/features.css">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://api.open-meteo.com">
    <link rel="preconnect" href="https://api.bigdatacloud.net">
    <link rel="dns-prefetch" href="https://unpkg.com">
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">SOS</div>
                <div class="sidebar-logo-text">Connect Pro</div>
            </div>
            <nav class="sidebar-nav">
                <button class="sidebar-item active" data-tab="terminal" data-i18n="nav_terminal">
                    <span class="sidebar-item-icon">üíª</span>
                    <span>Terminal</span>
                </button>
                <button class="sidebar-item" data-tab="weather" data-i18n="nav_weather">
                    <span class="sidebar-item-icon">üå§Ô∏è</span>
                    <span>Weather & Sensors</span>
                </button>
                <button class="sidebar-item" data-tab="emergency" data-i18n="nav_emergency">
                    <span class="sidebar-item-icon">üö®</span>
                    <span>Emergency</span>
                </button>
                <button class="sidebar-item" data-tab="analytics" data-i18n="nav_analytics">
                    <span class="sidebar-item-icon">üìä</span>
                    <span>Analytics</span>
                </button>
                <button class="sidebar-item" data-tab="config" data-i18n="nav_config">
                    <span class="sidebar-item-icon">‚öôÔ∏è</span>
                    <span>Configuration</span>
                </button>
            </nav>
            <div class="sidebar-status">
                <span class="sidebar-status-dot" id="sidebarStatusDot"></span>
                <span class="sidebar-status-text" id="sidebarStatusText">Disconnected</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content-area">
        <header>
            <div class="logo">
                <div class="logo-icon">SOS</div>
                <h1>SOS Connect Pro</h1>
            </div>
            <div class="status">
                <span class="status-indicator" id="statusIndicator"></span>
                <span class="status-indicator" id="statusIndicator2"></span>
                <span class="status-text" id="statusText" aria-live="polite">Disconnected</span>
            </div>
        </header>

        <!-- Dynamic Island - Interactive Notification Hub -->
        <div class="dynamic-island" id="dynamicIsland">
            <div class="island-content" id="islandContent">
                <!-- Default Compact State -->
                <div class="island-state island-compact active" id="islandCompact">
                    <div class="island-dot"></div>
                </div>

                <!-- Connection Status State -->
                <div class="island-state island-connection" id="islandConnection">
                    <div class="island-icon connection-icon">üì°</div>
                    <div class="island-text">
                        <div class="island-title">Serial Connected</div>
                        <div class="island-subtitle">115200 baud</div>
                    </div>
                    <div class="island-pulse"></div>
                </div>

                <!-- Sensor Alert State -->
                <div class="island-state island-sensor" id="islandSensor">
                    <div class="island-icon sensor-icon">üå°Ô∏è</div>
                    <div class="island-text">
                        <div class="island-title">Temperature Alert</div>
                        <div class="island-subtitle">35.2¬∞C - High</div>
                    </div>
                    <div class="island-wave"></div>
                </div>

                <!-- Emergency State -->
                <div class="island-state island-emergency" id="islandEmergency">
                    <div class="island-icon emergency-icon">üö®</div>
                    <div class="island-text">
                        <div class="island-title">EMERGENCY DETECTED</div>
                        <div class="island-subtitle">Tap to acknowledge</div>
                    </div>
                    <div class="island-ripple"></div>
                </div>

                <!-- Weather Update State -->
                <div class="island-state island-weather" id="islandWeather">
                    <div class="island-icon weather-icon">üå§Ô∏è</div>
                    <div class="island-text">
                        <div class="island-title">Weather Update</div>
                        <div class="island-subtitle">29¬∞C, Sunny</div>
                    </div>
                </div>

                <!-- Data Transfer State -->
                <div class="island-state island-data" id="islandData">
                    <div class="island-icon data-icon">üìä</div>
                    <div class="island-text">
                        <div class="island-title">Receiving Data</div>
                        <div class="island-subtitle">
                            <div class="island-progress">
                                <div class="island-progress-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multi-Activity Expanded State -->
                <div class="island-state island-expanded" id="islandExpanded">
                    <div class="island-split-view">
                        <div class="island-activity">
                            <div class="activity-icon">üì°</div>
                            <div class="activity-info">
                                <div class="activity-label">Connection</div>
                                <div class="activity-status">Active</div>
                            </div>
                        </div>
                        <div class="island-divider"></div>
                        <div class="island-activity">
                            <div class="activity-icon">üå°Ô∏è</div>
                            <div class="activity-info">
                                <div class="activity-label">Sensors</div>
                                <div class="activity-status">Monitoring</div>
                            </div>
                        </div>
                    </div>
                    <button class="island-close" id="islandClose">‚úï</button>
                </div>

                <!-- AI Assistant Active State -->
                <div class="island-state island-ai" id="islandAI">
                    <div class="island-icon ai-icon">ü§ñ</div>
                    <div class="island-text">
                        <div class="island-title">AI Responding</div>
                        <div class="island-subtitle">
                            <div class="typing-dots">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Progress State -->
                <div class="island-state island-download" id="islandDownload">
                    <div class="island-icon download-icon">üíæ</div>
                    <div class="island-text">
                        <div class="island-title">Saving Log</div>
                        <div class="island-subtitle">
                            <div class="island-circular-progress">
                                <svg viewBox="0 0 36 36">
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                                    <path class="circle-progress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#60a5fa" stroke-width="3" stroke-dasharray="100, 100"/>
                                </svg>
                                <span class="progress-percent">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Tab Navigation -->
        <div class="main-tabs">
            <button class="main-tab active" data-tab="terminal" aria-pressed="true">
                <span class="tab-icon">üíª</span>
                <span class="tab-label">Terminal</span>
            </button>
            <button class="main-tab" data-tab="weather" aria-pressed="false">
                <span class="tab-icon">üå§Ô∏è</span>
                <span class="tab-label">Weather & Sensors</span>
            </button>
            <button class="main-tab" data-tab="emergency" aria-pressed="false">
                <span class="tab-icon">üö®</span>
                <span class="tab-label">Emergency</span>
            </button>
            <button class="main-tab" data-tab="analytics" aria-pressed="false">
                <span class="tab-icon">üìä</span>
                <span class="tab-label">Analytics</span>
            </button>
            <button class="main-tab" data-tab="config" aria-pressed="false">
                <span class="tab-icon">‚öôÔ∏è</span>
                <span class="tab-label">Configuration</span>
            </button>
        </div>

        <!-- Terminal Tab Content -->
        <div class="tab-content active" id="terminalTab">
            <div class="controls">
                <button class="btn btn-disconnect" id="connectBtn" aria-label="Connect to device">
                    <span class="btn-icon">üì°</span>
                    CONNECT
                </button>
                <button class="btn btn-clear" id="clearBtn" aria-label="Clear terminal output">
                    <span class="btn-icon">üóëÔ∏è</span>
                    CLEAR
                </button>
                <button class="btn btn-scroll" id="autoScrollBtn" aria-pressed="true" aria-label="Toggle auto scroll">
                    <span class="btn-icon">üìú</span>
                    AUTO-SCROLL: ON
                </button>
                <button class="btn btn-download" id="downloadBtn" aria-label="Save log to file">
                    <span class="btn-icon">üíæ</span>
                    SAVE LOG
                </button>
            </div>

            <div class="terminal" id="terminal">
                <div class="terminal-content" id="terminalContent">
                    Waiting for data...
                </div>
            </div>
        </div>

        <!-- Weather & Sensors Tab Content -->
        <div class="tab-content" id="weatherTab">
            <!-- New Masonry Grid Layout -->
            <div class="weather-sensors-grid">
                
                <!-- Hero Weather Card -->
                <div class="grid-item hero-weather-card">
                    <div class="card-inner">
                        <div class="weather-hero-icon" id="weatherIconLarge">‚òÄÔ∏è</div>
                        <div class="weather-hero-temp" id="weatherTempLarge">29¬∞C</div>
                        <div class="weather-hero-condition" id="weatherCondition">Sunny</div>
                        <div class="weather-hero-location" id="weatherTime">Friday, 5:00 pm</div>
                        <div class="weather-hero-stats">
                            <div class="hero-stat">
                                <span class="hero-stat-icon">üíß</span>
                                <span class="hero-stat-label">Precip</span>
                                <span class="hero-stat-value" id="panelPrecip">0%</span>
                            </div>
                            <div class="hero-stat">
                                <span class="hero-stat-icon">üí¶</span>
                                <span class="hero-stat-label">Humidity</span>
                                <span class="hero-stat-value" id="panelHumidity">59%</span>
                            </div>
                            <div class="hero-stat">
                                <span class="hero-stat-icon">üí®</span>
                                <span class="hero-stat-label">Wind</span>
                                <span class="hero-stat-value" id="panelWind">18 km/h</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sensor Gauge Cards -->
                <div class="grid-item sensor-gauge-card temperature-card">
                    <div class="card-inner">
                        <div class="sensor-gauge-header">
                            <span class="sensor-gauge-icon">üå°Ô∏è</span>
                            <h3>Temperature</h3>
                        </div>
                        <div class="circular-gauge">
                            <svg class="gauge-svg" viewBox="0 0 200 200">
                                <defs>
                                    <linearGradient id="tempGaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="gauge-bg" cx="100" cy="100" r="80" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="16"/>
                                <circle class="gauge-fill temp-gauge-fill" cx="100" cy="100" r="80" fill="none" stroke="url(#tempGaugeGradient)" stroke-width="16" stroke-linecap="round" id="tempGaugeFill"/>
                            </svg>
                            <div class="gauge-center">
                                <div class="gauge-value" id="tempValue">--¬∞C</div>
                                <div class="gauge-label">Current</div>
                            </div>
                        </div>
                        <div class="gauge-range">
                            <span>0¬∞C</span>
                            <span>50¬∞C</span>
                        </div>
                    </div>
                </div>

                <div class="grid-item sensor-gauge-card humidity-card">
                    <div class="card-inner">
                        <div class="sensor-gauge-header">
                            <span class="sensor-gauge-icon">üíß</span>
                            <h3>Humidity</h3>
                        </div>
                        <div class="circular-gauge">
                            <svg class="gauge-svg" viewBox="0 0 200 200">
                                <defs>
                                    <linearGradient id="humidityGaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#06b6d4;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="gauge-bg" cx="100" cy="100" r="80" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="16"/>
                                <circle class="gauge-fill humidity-gauge-fill" cx="100" cy="100" r="80" fill="none" stroke="url(#humidityGaugeGradient)" stroke-width="16" stroke-linecap="round" id="humidityGaugeFill"/>
                            </svg>
                            <div class="gauge-center">
                                <div class="gauge-value" id="humidityValue">--%</div>
                                <div class="gauge-label">Current</div>
                            </div>
                        </div>
                        <div class="gauge-range">
                            <span>0%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>

                <div class="grid-item sensor-gauge-card ph-card">
                    <div class="card-inner">
                        <div class="sensor-gauge-header">
                            <span class="sensor-gauge-icon">üß™</span>
                            <h3>Soil pH</h3>
                        </div>
                        <div class="circular-gauge">
                            <svg class="gauge-svg" viewBox="0 0 200 200">
                                <defs>
                                    <linearGradient id="phGaugeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#34d399;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="gauge-bg" cx="100" cy="100" r="80" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="16"/>
                                <circle class="gauge-fill ph-gauge-fill" cx="100" cy="100" r="80" fill="none" stroke="url(#phGaugeGradient)" stroke-width="16" stroke-linecap="round" id="phGaugeFill"/>
                            </svg>
                            <div class="gauge-center">
                                <div class="gauge-value" id="phValue">--</div>
                                <div class="gauge-label" id="phStatus">Neutral</div>
                            </div>
                        </div>
                        <div class="gauge-range">
                            <span>3.0</span>
                            <span>10.0</span>
                        </div>
                    </div>
                </div>

                <!-- Weekly Forecast Card -->
                <div class="grid-item forecast-card">
                    <div class="card-inner">
                        <div class="forecast-header">
                            <span class="forecast-icon">ÔøΩ</span>
                            <h3>7-Day Forecast</h3>
                        </div>
                        <div class="forecast-scroll">
                            <div class="forecast-day">
                                <p class="day-name">Fri</p>
                                <span class="day-icon">‚òÄÔ∏è</span>
                                <p class="day-temp">33¬∞ / 24¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Sat</p>
                                <span class="day-icon">üå§</span>
                                <p class="day-temp">34¬∞ / 23¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Sun</p>
                                <span class="day-icon">üå•</span>
                                <p class="day-temp">33¬∞ / 23¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Mon</p>
                                <span class="day-icon">üå§</span>
                                <p class="day-temp">34¬∞ / 24¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Tue</p>
                                <span class="day-icon">üåß</span>
                                <p class="day-temp">33¬∞ / 24¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Wed</p>
                                <span class="day-icon">üå•</span>
                                <p class="day-temp">32¬∞ / 24¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Thu</p>
                                <span class="day-icon">‚òÅÔ∏è</span>
                                <p class="day-temp">32¬∞ / 23¬∞</p>
                            </div>
                            <div class="forecast-day">
                                <p class="day-name">Fri</p>
                                <span class="day-icon">üå§</span>
                                <p class="day-temp">32¬∞ / 23¬∞</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather Chart Card -->
                <div class="grid-item chart-card">
                    <div class="card-inner">
                        <div class="chart-card-header">
                            <h3>Weather Trends</h3>
                            <div class="chart-tabs-mini">
                                <button class="chart-tab-mini active" data-chart="temperature">Temp</button>
                                <button class="chart-tab-mini" data-chart="precipitation">Rain</button>
                                <button class="chart-tab-mini" data-chart="wind">Wind</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="hourlyWeatherChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Sensor Trends Graph Card (inside grid) -->
            <div class="grid-item trends-card">
                <div class="card-inner">
                    <div class="trends-header">
                        <span class="trends-icon">üìà</span>
                        <h3>Sensor Trends</h3>
                    </div>
                    <div class="trends-controls" role="group" aria-label="Select data series">
                        <button class="trend-btn active" data-series="temperature" aria-pressed="true">üå°Ô∏è Temp</button>
                        <button class="trend-btn" data-series="humidity" aria-pressed="false">üíß Humidity</button>
                        <button class="trend-btn" data-series="ph" aria-pressed="false">üß™ pH</button>
                    </div>
                    <div class="trends-canvas">
                        <canvas id="sensorTrendsCanvas" width="600" height="300" aria-label="Sensor trends chart" role="img"></canvas>
                    </div>
                </div>
            </div>

            <!-- Location Map Card -->
            <div class="grid-item" style="grid-column: span 2;">
                <div class="card-inner">
                    <div class="map-widget-header" style="border: none; padding: 0; background: none; margin-bottom: 15px;">
                        <div class="map-widget-title">
                            <span class="map-widget-title-icon">üìç</span>
                            <span>Device Location</span>
                        </div>
                    </div>
                    <div class="map-container" style="height: 250px; border-radius: 12px; overflow: hidden;">
                        <div id="locationMap" style="height: 100%; width: 100%;"></div>
                    </div>
                    <div class="map-controls" style="padding: 10px 0; background: none;">
                        <button class="map-control-btn" id="startTrackingBtn">
                            <span>üì°</span> Start Tracking
                        </button>
                        <button class="map-control-btn" id="showTrailBtn">
                            <span>üõ§Ô∏è</span> Show Trail
                        </button>
                        <button class="map-control-btn" id="centerMapBtn">
                            <span>üéØ</span> Center
                        </button>
                    </div>
                </div>
            </div>

            </div> <!-- Close weather-sensors-grid -->

        <!-- Weather Widget -->
        <div class="weather-widget" id="weatherWidget">
            <div class="weather-header">
                <span class="weather-icon" id="weatherIcon">üå§Ô∏è</span>
                <div class="weather-info">
                    <div class="weather-location" id="weatherLocation">Loading...</div>
                    <div class="weather-temp" id="weatherTemp">--¬∞C</div>
                </div>
            </div>
            
            <!-- Weather Tabs -->
            <div class="weather-tabs">
                <button class="weather-tab active" data-tab="main">Main</button>
                <button class="weather-tab" data-tab="details">Detailed Metrics</button>
            </div>
            
            <!-- Main Weather Tab -->
            <div class="weather-tab-content active" id="mainWeatherTab">
                <div class="weather-details">
                    <div class="weather-detail">
                        <span class="detail-icon">üí®</span>
                        <span id="weatherWind">-- km/h</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">üíß</span>
                        <span id="weatherHumidity">--%</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">üå°Ô∏è</span>
                        <span id="weatherFeels">--¬∞C</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">‚òÅÔ∏è</span>
                        <span id="weatherCloudCover">--%</span>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Metrics Tab -->
            <div class="weather-tab-content" id="detailsWeatherTab">
                <div class="weather-details">
                    <div class="weather-detail">
                        <span class="detail-icon">üå´Ô∏è</span>
                        <span id="weatherVisibility">-- km</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">üí¶</span>
                        <span id="weatherDewPoint">--¬∞C</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">‚òÄÔ∏è</span>
                        <span id="weatherUV">UV --</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">üå°Ô∏è</span>
                        <span id="weatherPressure">-- hPa</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">üîÜ</span>
                        <span id="weatherSolarRadiation">-- W/m¬≤</span>
                    </div>
                    <div class="weather-detail">
                        <span class="detail-icon">üí®</span>
                        <span id="weatherEvaporation">-- mm</span>
                    </div>
                </div>
            </div>
            
            <div class="weather-description" id="weatherDescription">--</div>
        </div>

        <!-- Crop Recommendation Widget -->
        <div class="crop-widget" id="cropWidget">
            <div class="crop-header">
                <span class="crop-icon">üåæ</span>
                <h2 class="crop-title">Crop Planting Recommendations</h2>
            </div>
            <div class="crop-content">
                <div class="crop-season" id="cropSeason">Current Season: Loading...</div>
                <div class="crop-recommendations" id="cropRecommendations">
                    <div class="crop-item">
                        <span class="crop-emoji">üå±</span>
                        <span class="crop-name">Loading recommendations...</span>
                    </div>
                </div>
                <div class="crop-tips" id="cropTips">
                    <div class="tip-title">üí° Farming Tips:</div>
                    <div class="tip-content" id="tipContent">Loading...</div>
                </div>
            </div>
        </div>
        </div>

        <!-- Configuration Tab Content -->
        <div class="tab-content" id="configTab">
            <div class="config-container">
                <div class="config-header">
                    <span class="config-icon">‚öôÔ∏è</span>
                    <h2 class="config-title">System Configuration</h2>
                </div>
                
                <!-- Theme Settings -->
                <div class="config-section">
                    <h3 class="config-section-title">
                        <span class="section-icon">üé®</span>
                        Theme Settings
                    </h3>
                    <div class="config-group">
                        <label class="config-label">
                            <span>Color Theme</span>
                            <div class="theme-selector">
                                <button class="theme-btn" data-theme="normal" title="Normal Theme">
                                    <span class="theme-icon">üåà</span>
                                    <span class="theme-label">Normal</span>
                                </button>
                                <button class="theme-btn" data-theme="light" title="Light Theme">
                                    <span class="theme-icon">‚òÄÔ∏è</span>
                                    <span class="theme-label">Light</span>
                                </button>
                                <button class="theme-btn" data-theme="dark" title="Dark Theme">
                                    <span class="theme-icon">üåô</span>
                                    <span class="theme-label">Dark</span>
                                </button>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Serial Port Settings -->
                <div class="config-section">
                    <h3 class="config-section-title">
                        <span class="section-icon">üîå</span>
                        Serial Port Settings
                    </h3>
                    <div class="config-group">
                        <label class="config-label">
                            <span>Baud Rate</span>
                            <select class="config-select" id="baudRate">
                                <option value="9600">9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                                <option value="57600">57600</option>
                                <option value="115200" selected>115200</option>
                            </select>
                        </label>
                        <label class="config-label">
                            <span>Data Bits</span>
                            <select class="config-select" id="dataBits">
                                <option value="7">7</option>
                                <option value="8" selected>8</option>
                            </select>
                        </label>
                        <label class="config-label">
                            <span>Stop Bits</span>
                            <select class="config-select" id="stopBits">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                            </select>
                        </label>
                        <label class="config-label">
                            <span>Parity</span>
                            <select class="config-select" id="parity">
                                <option value="none" selected>None</option>
                                <option value="even">Even</option>
                                <option value="odd">Odd</option>
                            </select>
                        </label>
                    </div>
                </div>

                <!-- Display Settings -->
                <div class="config-section">
                    <h3 class="config-section-title">
                        <span class="section-icon">üé®</span>
                        Display Settings
                    </h3>
                    <div class="config-group">
                        <label class="config-label checkbox-label">
                            <input type="checkbox" id="autoScrollConfig" checked>
                            <span>Auto-scroll terminal</span>
                        </label>
                        <label class="config-label checkbox-label">
                            <input type="checkbox" id="timestampsConfig">
                            <span>Show timestamps</span>
                        </label>
                        <label class="config-label checkbox-label">
                            <input type="checkbox" id="soundEffectsConfig" checked>
                            <span>Sound effects</span>
                        </label>
                        <label class="config-label">
                            <span>Font Size</span>
                            <input type="range" class="config-range" id="fontSize" min="12" max="24" value="16">
                            <span class="range-value" id="fontSizeValue">16px</span>
                        </label>
                    </div>
                </div>

                <!-- Data Settings -->
                <div class="config-section">
                    <h3 class="config-section-title">
                        <span class="section-icon">üìä</span>
                        Data Settings
                    </h3>
                    <div class="config-group">
                        <label class="config-label">
                            <span>Max Log Size (lines)</span>
                            <input type="number" class="config-input" id="maxLogSize" value="1000" min="100" max="10000">
                        </label>
                        <label class="config-label">
                            <span>Trend Chart Points</span>
                            <input type="number" class="config-input" id="trendPoints" value="20" min="10" max="50">
                        </label>
                        <label class="config-label">
                            <span>Update Interval (ms)</span>
                            <input type="number" class="config-input" id="updateInterval" value="5000" min="1000" max="30000" step="1000">
                        </label>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="config-section">
                    <h3 class="config-section-title">
                        <span class="section-icon">üîî</span>
                        Notification Settings
                    </h3>
                    <div class="config-group">
                        <label class="config-label checkbox-label">
                            <input type="checkbox" id="emergencyAlerts" checked>
                            <span>Emergency alerts</span>
                        </label>
                        <label class="config-label checkbox-label">
                            <input type="checkbox" id="systemNotifications" checked>
                            <span>System notifications</span>
                        </label>
                        <label class="config-label checkbox-label">
                            <input type="checkbox" id="weatherAlerts" checked>
                            <span>Weather alerts</span>
                        </label>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="config-section">
                    <h3 class="config-section-title">
                        <span class="section-icon">üîß</span>
                        Advanced Settings
                    </h3>
                    <div class="config-group">
                        <label class="config-label">
                            <span>Location (for weather)</span>
                            <input type="text" class="config-input" id="locationInput" placeholder="Auto-detected">
                        </label>
                        <label class="config-label">
                            <span>Temperature Unit</span>
                            <select class="config-select" id="tempUnit">
                                <option value="celsius" selected>Celsius (¬∞C)</option>
                                <option value="fahrenheit">Fahrenheit (¬∞F)</option>
                            </select>
                        </label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="config-actions">
                    <button class="config-btn save-btn" id="saveConfig">
                        <span>üíæ</span> Save Configuration
                    </button>
                    <button class="config-btn reset-btn" id="resetConfig">
                        <span>üîÑ</span> Reset to Defaults
                    </button>
                    <button class="config-btn export-btn" id="exportConfig">
                        <span>üì§</span> Export Settings
                    </button>
                    <button class="config-btn import-btn" id="importConfig">
                        <span>üì•</span> Import Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Emergency Tab Content -->
        <div class="tab-content" id="emergencyTab">
            <div class="emergency-dashboard">
                <!-- Emergency Contacts Panel -->
                <div class="emergency-contacts-panel">
                    <div class="emergency-contacts-header">
                        <div class="emergency-contacts-title">
                            <span>üìû</span>
                            <span>Emergency Contacts</span>
                        </div>
                        <button class="add-contact-btn" id="addContactBtn">+ Add Contact</button>
                    </div>
                    <div class="contact-list" id="contactList">
                        <!-- Contacts will be populated dynamically -->
                        <div class="no-contacts-message" style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">
                            No emergency contacts added yet. Click "Add Contact" to add your first emergency contact.
                        </div>
                    </div>
                </div>

                <!-- Quick Dial Services -->
                <div class="emergency-contacts-panel" style="margin-top: 20px;">
                    <div class="emergency-contacts-header">
                        <div class="emergency-contacts-title">
                            <span>üö®</span>
                            <span>Emergency Services</span>
                        </div>
                    </div>
                    <div class="relay-controls" style="margin-top: 15px;">
                        <button class="relay-btn" onclick="window.emergencyManager?.dialEmergencyService('universal')">
                            <span style="font-size: 32px;">üìû</span>
                            <span class="relay-label">112 (Universal)</span>
                        </button>
                        <button class="relay-btn" onclick="window.emergencyManager?.dialEmergencyService('police')">
                            <span style="font-size: 32px;">üëÆ</span>
                            <span class="relay-label">Police (100)</span>
                        </button>
                        <button class="relay-btn" onclick="window.emergencyManager?.dialEmergencyService('ambulance')">
                            <span style="font-size: 32px;">üöë</span>
                            <span class="relay-label">Ambulance (102)</span>
                        </button>
                        <button class="relay-btn" onclick="window.emergencyManager?.dialEmergencyService('fire')">
                            <span style="font-size: 32px;">üöí</span>
                            <span class="relay-label">Fire (101)</span>
                        </button>
                    </div>
                </div>

                <!-- Panic Button -->
                <div class="panic-button-container" style="margin-top: 30px;">
                    <h3 style="color: #ef4444; margin-bottom: 15px; text-align: center;">Emergency Panic Button</h3>
                    <p style="text-align: center; color: rgba(255,255,255,0.6); margin-bottom: 20px; font-size: 0.9rem;">
                        Press and hold for 3 seconds to trigger emergency alert
                    </p>
                    <button class="panic-button" id="panicButton">
                        <span>SOS</span>
                    </button>
                    <p style="text-align: center; color: rgba(255,255,255,0.5); margin-top: 15px; font-size: 0.8rem;">
                        This will notify all your emergency contacts with your location
                    </p>
                </div>

                <!-- Location Sharing -->
                <div class="map-widget" style="margin-top: 30px;">
                    <div class="map-widget-header">
                        <div class="map-widget-title">
                            <span class="map-widget-title-icon">üìç</span>
                            <span>Your Location</span>
                        </div>
                    </div>
                    <div class="map-container">
                        <div id="emergencyMap" style="height: 100%; width: 100%;"></div>
                    </div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="shareLocationBtn">
                            <span>üì§</span> Share Location
                        </button>
                        <button class="map-control-btn" id="refreshLocationBtn">
                            <span>üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tab Content -->
        <div class="tab-content" id="analyticsTab">
            <div class="analytics-dashboard" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                
                <!-- Summary Stats -->
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">
                            <span>üìà</span>
                            <span>Data Summary</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="analyticsReadings">0</div>
                            <div class="analytics-stat-label">Total Readings</div>
                        </div>
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="analyticsUptime">0h</div>
                            <div class="analytics-stat-label">Session Time</div>
                        </div>
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="analyticsAlerts">0</div>
                            <div class="analytics-stat-label">Alerts Today</div>
                        </div>
                    </div>
                </div>

                <!-- Sensor Analytics -->
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">
                            <span>üå°Ô∏è</span>
                            <span>Temperature Analytics</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="tempMin">--</div>
                            <div class="analytics-stat-label">Min</div>
                        </div>
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="tempMax">--</div>
                            <div class="analytics-stat-label">Max</div>
                        </div>
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="tempAvg">--</div>
                            <div class="analytics-stat-label">Average</div>
                        </div>
                    </div>
                    <div class="analytics-trend stable" id="tempTrend" style="margin-top: 10px;">
                        <span>‚Üí</span> Stable
                    </div>
                </div>

                <!-- Humidity Analytics -->
                <div class="analytics-card">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">
                            <span>üíß</span>
                            <span>Humidity Analytics</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="humidityMin">--</div>
                            <div class="analytics-stat-label">Min</div>
                        </div>
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="humidityMax">--</div>
                            <div class="analytics-stat-label">Max</div>
                        </div>
                        <div class="analytics-stat">
                            <div class="analytics-stat-value" id="humidityAvg">--</div>
                            <div class="analytics-stat-label">Average</div>
                        </div>
                    </div>
                    <div class="analytics-trend stable" id="humidityTrend" style="margin-top: 10px;">
                        <span>‚Üí</span> Stable
                    </div>
                </div>

                <!-- Export Options -->
                <div class="analytics-card" style="grid-column: span 2;">
                    <div class="analytics-card-header">
                        <div class="analytics-card-title">
                            <span>üì•</span>
                            <span>Data Export</span>
                        </div>
                    </div>
                    <p style="color: rgba(255,255,255,0.6); margin: 15px 0; font-size: 0.9rem;">
                        Export your sensor data and activity logs in various formats for analysis or backup.
                    </p>
                    <div class="export-buttons">
                        <button class="export-btn csv" id="exportCSVBtn">
                            <span>üìÑ</span> Export CSV
                        </button>
                        <button class="export-btn json" id="exportJSONBtn">
                            <span>üìã</span> Export JSON
                        </button>
                        <button class="export-btn excel" id="exportExcelBtn">
                            <span>üìä</span> Export Excel
                        </button>
                    </div>
                    <div style="margin-top: 20px;">
                        <label style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">Time Range:</label>
                        <select id="exportTimeRange" style="margin-left: 10px; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
                            <option value="hour">Last Hour</option>
                            <option value="day" selected>Last 24 Hours</option>
                            <option value="week">Last Week</option>
                            <option value="month">Last Month</option>
                            <option value="all">All Data</option>
                        </select>
                    </div>
                </div>

                <!-- Activity Log -->
                <div class="activity-log-panel" style="grid-column: span 2;">
                    <div class="activity-log-header">
                        <div class="activity-log-title">
                            <span>üìã</span>
                            <span>Activity Log</span>
                        </div>
                        <div class="activity-log-filters">
                            <button class="log-filter-btn active" data-filter="all">All</button>
                            <button class="log-filter-btn" data-filter="connection">Connection</button>
                            <button class="log-filter-btn" data-filter="sensor">Sensor</button>
                            <button class="log-filter-btn" data-filter="error">Errors</button>
                        </div>
                    </div>
                    <div class="activity-log-list" id="activityLogList">
                        <!-- Activity entries will be populated dynamically -->
                        <div class="log-entry">
                            <span class="log-icon">‚úÖ</span>
                            <div class="log-content">
                                <div class="log-action">Application started</div>
                                <div class="log-details">SOS Connect Pro initialized</div>
                            </div>
                            <span class="log-timestamp">Just now</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Crop Wiki Modal -->
        <div class="crop-wiki-overlay" id="cropWikiOverlay">
            <div class="crop-wiki-modal">
                <button class="crop-wiki-close" id="cropWikiClose">‚úï</button>
                <div class="crop-wiki-header">
                    <span class="crop-wiki-icon" id="cropWikiIcon">üåæ</span>
                    <h2 class="crop-wiki-title" id="cropWikiTitle">Crop Information</h2>
                </div>
                <div class="crop-wiki-content" id="cropWikiContent">
                    <div class="wiki-loading">Loading crop information...</div>
                </div>
            </div>
        </div>

        <!-- Emergency Alert Overlay -->
        <div class="emergency-overlay" id="emergencyOverlay">
            <div class="emergency-modal">
                <div class="emergency-icon" id="emergencyIcon">‚ö†Ô∏è</div>
                <h2 class="emergency-title" id="emergencyTitle">EMERGENCY ALERT</h2>
                <p class="emergency-message" id="emergencyMessage">Emergency detected!</p>
                <button class="btn btn-acknowledge" id="acknowledgeBtn">
                    <span class="btn-icon">‚úì</span>
                    ACKNOWLEDGE
                </button>
            </div>
        </div>

        <!-- AI Assistant Open Button -->
        <button class="ai-open-btn" id="aiOpenBtn" title="Open AI Assistant">
            <span class="ai-open-icon">ü§ñ</span>
            <span class="ai-open-text">AI</span>
        </button>

        <!-- AI Assistant Widget -->
        <div class="ai-assistant" id="aiAssistant">
            <div class="ai-header">
                <div class="ai-avatar">ü§ñ</div>
                <div class="ai-info">
                    <h3 class="ai-name">SOS AI</h3>
                    <div class="ai-status" id="aiStatus"></div>
                </div>
                <button class="ai-mode-selector" id="aiModeSelector" title="Switch AI Mode">
                    <span class="mode-icon">‚ö°</span>
                    <span class="mode-text">SOS AI</span>
                </button>
                <button class="ai-clear-chat" id="aiClearChat" title="Clear chat history">üóëÔ∏è</button>
                <button class="ai-close-btn" id="aiCloseBtn" title="Close AI Assistant">‚úï</button>
            </div>
            
            <!-- AI Mode Selection Menu -->
            <div class="ai-mode-menu" id="aiModeMenu">
                <div class="mode-menu-header">Select AI Mode</div>
                <button class="mode-option" data-mode="sos">
                    <span class="mode-option-icon">‚ö°</span>
                    <div class="mode-option-info">
                        <div class="mode-option-title">SOS AI (Offline)</div>
                        <div class="mode-option-desc">Fast responses, works without internet</div>
                    </div>
                    <span class="mode-check">‚úì</span>
                </button>
                <button class="mode-option" data-mode="gemini">
                    <span class="mode-option-icon">üåü</span>
                    <div class="mode-option-info">
                        <div class="mode-option-title">Gemini AI (Online)</div>
                        <div class="mode-option-desc">Advanced AI, requires internet & API key</div>
                    </div>
                    <span class="mode-check">‚úì</span>
                </button>
                
                <!-- API Key Management Section -->
                <div class="api-key-section">
                    <div class="api-key-header">
                        <span class="api-key-icon">üîë</span>
                        <span class="api-key-title">Gemini API Key</span>
                    </div>
                    <div class="api-key-status" id="apiKeyStatus">
                        <span class="api-status-text">No API key set</span>
                    </div>
                    <div class="api-key-actions">
                        <button class="api-key-btn" id="setApiKeyBtn">
                            <span>üîß</span> Set Key
                        </button>
                        <button class="api-key-btn" id="viewApiKeyBtn" style="display: none;">
                            <span>üëÅÔ∏è</span> View
                        </button>
                        <button class="api-key-btn danger" id="removeApiKeyBtn" style="display: none;">
                            <span>üóëÔ∏è</span> Remove
                        </button>
                    </div>
                    <div class="api-key-info">
                        <small>Get your free API key from: <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                    </div>
                </div>
                
                <div class="mode-menu-footer">
                    <small>Type <code>#gemini</code> in chat to switch quickly</small>
                </div>
            </div>
            <div class="ai-body" id="aiBody">
                <div class="ai-chat" id="aiChat">
                    <div class="ai-message ai-assistant-message">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <strong>Hello!</strong> I'm your SOS Connect Pro AI Assistant. I can help you with:
                            <br>‚Ä¢ Serial connection issues
                            <br>‚Ä¢ Weather interpretation
                            <br>‚Ä¢ Crop recommendations
                            <br>‚Ä¢ Emergency alerts
                            <br>‚Ä¢ Data analysis
                            <br><br>Just type your question below!
                        </div>
                    </div>
                </div>
                <div class="ai-input-container">
                    <input type="text" class="ai-input" id="aiInput" placeholder="Ask me anything..." aria-label="Chat input">
                    <button class="ai-send-btn" id="aiSendBtn">
                        <span>‚û§</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification Center -->
        <div class="notification-center" id="notificationCenter">
            <button class="notification-bell" id="notificationBell" aria-label="Open notifications" aria-haspopup="true" aria-expanded="false">
                <span class="bell-icon">üîî</span>
                <span class="notification-badge" id="notificationBadge">0</span>
            </button>
            <div class="notification-panel" id="notificationPanel">
                <div class="notification-header">
                    <h3>üì¨ Notifications</h3>
                    <button class="clear-notifications" id="clearNotifications">Clear All</button>
                </div>
                <div class="notification-list" id="notificationList">
                    <div class="no-notifications">No notifications yet</div>
                </div>
            </div>
        </div>
        </div> <!-- Close main-content-area -->
    </div> <!-- Close container -->

    <!-- Audio element for connection sound -->
    <audio id="connectionSound" preload="auto">
        <source src="./sounds/connect.mp3" type="audio/mpeg">
        <source src="./sounds/connect.ogg" type="audio/ogg">
        <source src="./sounds/connect.wav" type="audio/wav">
    </audio>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <div class="offline-indicator-text">
            <span>üì°</span> You are currently offline. Some features may be unavailable.
        </div>
    </div>

    <!-- PWA Install Prompt -->
    <div class="pwa-install-prompt hidden" id="pwaInstallPrompt">
        <div class="pwa-install-icon">üì±</div>
        <div class="pwa-install-content">
            <div class="pwa-install-title">Install SOS Connect Pro</div>
            <div class="pwa-install-text">Add to home screen for a better experience</div>
        </div>
        <div class="pwa-install-actions">
            <button class="pwa-install-btn primary" id="pwaInstallBtn">Install</button>
            <button class="pwa-install-btn secondary" id="pwaInstallDismiss">Later</button>
        </div>
    </div>

    <!-- Voice Control Button -->
    <button class="voice-control-btn" id="voiceControlBtn" aria-label="Voice Commands" title="Click to speak a command">
        üé§
    </button>
    <div class="voice-transcript hidden" id="voiceTranscript">
        <span class="voice-transcript-text" id="voiceTranscriptText">Listening...</span>
    </div>

    <!-- External Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="" defer></script>
    <script 
        src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" 
        defer 
        onerror="handleChartJSError()">
    </script>
    <script>
        function handleChartJSError() {
            console.error('Failed to load Chart.js from CDN');
            const chartContainer = document.getElementById('hourlyWeatherChart');
            if (chartContainer && chartContainer.parentElement) {
                chartContainer.parentElement.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Weather charts unavailable - CDN loading failed</p>';
            }
        }
    </script>

    <!-- Feature Modules -->
    <script src="js/features/notifications.js" defer></script>
    <script src="js/features/voice-commands.js" defer></script>
    <script src="js/features/data-analytics.js" defer></script>
    <script src="js/features/location-map.js" defer></script>
    <script src="js/features/device-control.js" defer></script>
    <script src="js/features/emergency-system.js" defer></script>
    <script src="js/features/activity-log.js" defer></script>
    <script src="js/features/i18n.js" defer></script>

    <!-- Main Application Script -->
    <script src="script.js" defer></script>

    <!-- Service Worker Registration & Feature Initialization -->
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('[App] Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('[App] Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installPrompt = document.getElementById('pwaInstallPrompt');
            if (installPrompt) {
                installPrompt.classList.remove('hidden');
            }
        });

        document.getElementById('pwaInstallBtn')?.addEventListener('click', async () => {
            const installPrompt = document.getElementById('pwaInstallPrompt');
            if (installPrompt) installPrompt.classList.add('hidden');
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('[App] Install prompt outcome:', outcome);
                deferredPrompt = null;
            }
        });

        document.getElementById('pwaInstallDismiss')?.addEventListener('click', () => {
            const installPrompt = document.getElementById('pwaInstallPrompt');
            if (installPrompt) installPrompt.classList.add('hidden');
        });

        // Offline/Online Detection
        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (indicator) {
                if (navigator.onLine) {
                    indicator.classList.remove('show');
                } else {
                    indicator.classList.add('show');
                }
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // Initialize Feature Managers after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize feature managers
            window.notificationsManager = window.NotificationsManager ? new NotificationsManager() : null;
            window.voiceCommandsManager = window.VoiceCommandsManager ? new VoiceCommandsManager() : null;
            window.dataAnalyticsManager = window.DataAnalyticsManager ? new DataAnalyticsManager() : null;
            window.locationManager = window.LocationMapManager ? new LocationMapManager() : null;
            window.deviceControlManager = window.DeviceControlManager ? new DeviceControlManager() : null;
            window.emergencyManager = window.EmergencySystemManager ? new EmergencySystemManager() : null;
            window.activityLogManager = window.ActivityLogManager ? new ActivityLogManager() : null;
            window.i18nManager = window.I18nManager ? new I18nManager() : null;

            // Request notification permission after user interaction
            if (window.notificationsManager) {
                document.body.addEventListener('click', () => {
                    if (Notification.permission === 'default') {
                        window.notificationsManager.init();
                    }
                }, { once: true });
            }

            // Voice Control Button
            const voiceBtn = document.getElementById('voiceControlBtn');
            const voiceTranscript = document.getElementById('voiceTranscript');
            
            if (voiceBtn && window.voiceCommandsManager) {
                voiceBtn.addEventListener('click', () => {
                    if (window.voiceCommandsManager.isListening) {
                        window.voiceCommandsManager.stopListening();
                        voiceBtn.classList.remove('listening');
                        voiceTranscript?.classList.add('hidden');
                    } else {
                        window.voiceCommandsManager.startListening();
                        voiceBtn.classList.add('listening');
                        voiceTranscript?.classList.remove('hidden');
                    }
                });

                window.addEventListener('voice-listening-end', () => {
                    voiceBtn.classList.remove('listening');
                    setTimeout(() => voiceTranscript?.classList.add('hidden'), 2000);
                });

                window.addEventListener('voice-transcript', (e) => {
                    const transcriptText = document.getElementById('voiceTranscriptText');
                    if (transcriptText) {
                        transcriptText.textContent = e.detail.final || e.detail.interim || 'Listening...';
                        transcriptText.className = e.detail.final ? 'voice-transcript-text final' : 'voice-transcript-text';
                    }
                });
            } else if (voiceBtn) {
                // Hide voice button if not supported
                voiceBtn.style.display = 'none';
            }

            // Log app start
            if (window.activityLogManager) {
                window.activityLogManager.logSystem('Application started', {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    online: navigator.onLine
                });
            }

            // Initialize Maps when Weather tab is shown (lazy loading)
            let weatherMapInitialized = false;
            let emergencyMapInitialized = false;

            function initializeWeatherMap() {
                if (weatherMapInitialized || !window.locationManager || typeof L === 'undefined') return;
                try {
                    window.locationManager.initMap('locationMap');
                    weatherMapInitialized = true;
                    console.log('[App] Weather map initialized');
                } catch (e) {
                    console.error('[App] Weather map init error:', e);
                }
            }

            function initializeEmergencyMap() {
                if (emergencyMapInitialized || typeof L === 'undefined') return;
                try {
                    const emergencyMap = L.map('emergencyMap').setView([20.5937, 78.9629], 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(emergencyMap);
                    
                    // Get current location for emergency map
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition((pos) => {
                            const { latitude, longitude } = pos.coords;
                            emergencyMap.setView([latitude, longitude], 15);
                            L.marker([latitude, longitude]).addTo(emergencyMap)
                                .bindPopup('Your Location').openPopup();
                        });
                    }
                    emergencyMapInitialized = true;
                    console.log('[App] Emergency map initialized');
                } catch (e) {
                    console.error('[App] Emergency map init error:', e);
                }
            }

            // Tab change observer for lazy loading maps
            const tabObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        const target = mutation.target;
                        if (target.classList.contains('active')) {
                            if (target.id === 'weatherTab' && !weatherMapInitialized) {
                                setTimeout(initializeWeatherMap, 100);
                            }
                            if (target.id === 'emergencyTab' && !emergencyMapInitialized) {
                                setTimeout(initializeEmergencyMap, 100);
                            }
                        }
                    }
                });
            });

            // Observe tab content changes
            document.querySelectorAll('.tab-content').forEach(tab => {
                tabObserver.observe(tab, { attributes: true });
            });

            // Map Control Buttons
            document.getElementById('startTrackingBtn')?.addEventListener('click', () => {
                if (window.locationManager) {
                    if (window.locationManager.isTracking) {
                        window.locationManager.stopTracking();
                        document.getElementById('startTrackingBtn').innerHTML = '<span>üì°</span> Start Tracking';
                    } else {
                        window.locationManager.startTracking();
                        document.getElementById('startTrackingBtn').innerHTML = '<span>üõë</span> Stop Tracking';
                    }
                }
            });

            document.getElementById('showTrailBtn')?.addEventListener('click', () => {
                if (window.locationManager) {
                    window.locationManager.drawTrail();
                }
            });

            document.getElementById('centerMapBtn')?.addEventListener('click', () => {
                if (window.locationManager) {
                    window.locationManager.getCurrentLocation();
                }
            });

            document.getElementById('shareLocationBtn')?.addEventListener('click', async () => {
                if (window.locationManager) {
                    const shared = await window.locationManager.shareLocation('Emergency! I need help.');
                    if (shared) {
                        window.notificationsManager?.show({
                            title: 'Location Shared',
                            body: 'Your location has been shared',
                            icon: 'üìç',
                            type: 'success'
                        });
                    }
                }
            });

            document.getElementById('refreshLocationBtn')?.addEventListener('click', () => {
                if (window.locationManager) {
                    window.locationManager.getCurrentLocation();
                }
            });

            // Panic Button
            const panicButton = document.getElementById('panicButton');
            let panicTimeout = null;

            panicButton?.addEventListener('mousedown', () => {
                panicButton.classList.add('counting');
                panicTimeout = setTimeout(() => {
                    if (window.emergencyManager) {
                        window.emergencyManager.triggerEmergency('PANIC', 'Manual panic button activated');
                    }
                    panicButton.classList.remove('counting');
                }, 3000);
            });

            panicButton?.addEventListener('mouseup', () => {
                if (panicTimeout) {
                    clearTimeout(panicTimeout);
                    panicTimeout = null;
                }
                panicButton.classList.remove('counting');
            });

            panicButton?.addEventListener('mouseleave', () => {
                if (panicTimeout) {
                    clearTimeout(panicTimeout);
                    panicTimeout = null;
                }
                panicButton.classList.remove('counting');
            });

            // Export buttons
            document.getElementById('exportCSVBtn')?.addEventListener('click', async () => {
                if (window.dataAnalyticsManager) {
                    const timeRange = document.getElementById('exportTimeRange')?.value || 'day';
                    const report = await window.dataAnalyticsManager.generateReport(timeRange);
                    // Export terminal log as CSV
                    const logs = window.activityLogManager?.getLogs({ limit: 1000 }) || [];
                    window.dataAnalyticsManager.exportToCSV(logs, `activity-log-${new Date().toISOString().split('T')[0]}.csv`);
                }
            });

            document.getElementById('exportJSONBtn')?.addEventListener('click', async () => {
                if (window.dataAnalyticsManager) {
                    const logs = window.activityLogManager?.getLogs({ limit: 1000 }) || [];
                    window.dataAnalyticsManager.exportToJSON(logs, `activity-log-${new Date().toISOString().split('T')[0]}.json`);
                }
            });

            document.getElementById('exportExcelBtn')?.addEventListener('click', async () => {
                if (window.dataAnalyticsManager) {
                    const logs = window.activityLogManager?.getLogs({ limit: 1000 }) || [];
                    window.dataAnalyticsManager.exportToExcel(logs, `activity-log-${new Date().toISOString().split('T')[0]}.xls`);
                }
            });

            // Activity log filter buttons
            document.querySelectorAll('.log-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.log-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filter = btn.dataset.filter;
                    updateActivityLogDisplay(filter);
                });
            });

            function updateActivityLogDisplay(filter = 'all') {
                if (!window.activityLogManager) return;
                const logs = filter === 'all' 
                    ? window.activityLogManager.getLogs({ limit: 50 })
                    : window.activityLogManager.getLogsByCategory(filter, 50);
                
                const container = document.getElementById('activityLogList');
                if (!container) return;

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.6); padding: 20px;">No activity logs found</div>';
                    return;
                }

                container.innerHTML = logs.map(log => `
                    <div class="log-entry ${log.level}">
                        <span class="log-icon">${getLogIcon(log.category)}</span>
                        <div class="log-content">
                            <div class="log-action">${escapeHtml(log.action)}</div>
                            <div class="log-details">${escapeHtml(JSON.stringify(log.details).substring(0, 100))}</div>
                        </div>
                        <span class="log-timestamp">${formatRelativeTime(log.timestamp)}</span>
                    </div>
                `).join('');
            }

            function getLogIcon(category) {
                const icons = {
                    connection: 'üîå',
                    sensor: 'üì°',
                    user: 'üë§',
                    system: '‚öôÔ∏è',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    emergency: 'üö®'
                };
                return icons[category] || 'üìã';
            }

            function escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            function formatRelativeTime(timestamp) {
                const now = new Date();
                const date = new Date(timestamp);
                const diff = Math.floor((now - date) / 1000);
                
                if (diff < 60) return 'Just now';
                if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                return `${Math.floor(diff / 86400)}d ago`;
            }

            // Update activity log on new entries
            window.addEventListener('activity-logged', () => {
                const activeFilter = document.querySelector('.log-filter-btn.active')?.dataset.filter || 'all';
                updateActivityLogDisplay(activeFilter);
            });

            console.log('[App] SOS Connect Pro initialized with features:', {
                notifications: !!window.notificationsManager,
                voice: !!window.voiceCommandsManager,
                analytics: !!window.dataAnalyticsManager,
                location: !!window.locationManager,
                deviceControl: !!window.deviceControlManager,
                emergency: !!window.emergencyManager,
                activityLog: !!window.activityLogManager,
                i18n: !!window.i18nManager
            });
        });
    </script>
</body>
</html>